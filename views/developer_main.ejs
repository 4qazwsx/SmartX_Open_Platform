<html lang="en"><head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>NILAB - Dashboard</title>
    <!-- Bootstrap core CSS-->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template-->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">

    <!-- Page level plugin CSS-->
    <link href="vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="css/sb-admin.css" rel="stylesheet">

  <style type="text/css">/* Chart.js */
@-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">/* Chart.js */
@-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">/* Chart.js */
@-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">/* Chart.js */
@-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">/* Chart.js */
@-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style><style type="text/css">/* Chart.js */
@-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style></head>

  <body id="page-top">

    <nav class="navbar navbar-expand navbar-dark bg-dark static-top">

      <a class="navbar-brand mr-1" href="client_main">NILAB</a>

      <button class="btn btn-link btn-sm text-white order-1 order-sm-0" id="sidebarToggle" href="#">
        <i class="fas fa-bars"></i>
      </button>

      <!-- Navbar Search -->
      <form class="d-none d-md-inline-block form-inline ml-auto mr-0 mr-md-3 my-2 my-md-0">
        <div class="input-group">
                <% if (user.role == 1) { %>
                    <h2 class="text-primary"> User  &nbsp; &nbsp; &nbsp; &nbsp; </h2>
                    <% } else if (user.role == 2) { %>
                      <h2 class="text-success"> Developer  &nbsp; &nbsp; &nbsp; &nbsp; </h2>
                      <% } else { %>
                        <h2 class="text-danger"> Manager  &nbsp; &nbsp; &nbsp; &nbsp;  </h2>
                        <% } %>      
          <input type="text" class="form-control" placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2">
          <div class="input-group-append">
            <button class="btn btn-primary" type="button">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
      </form>

      <!-- Navbar -->
      <ul class="navbar-nav ml-auto ml-md-0">
        <li class="nav-item dropdown no-arrow mx-1">
          <a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-bell fa-fw"></i>
            <span class="badge badge-danger">9+</span>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="alertsDropdown">
            <a class="dropdown-item" href="#">Action</a>
            <a class="dropdown-item" href="#">Another action</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#">Something else here</a>
          </div>
        </li>
        <li class="nav-item dropdown no-arrow mx-1">
          <a class="nav-link dropdown-toggle" href="#" id="messagesDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-envelope fa-fw"></i>
            <span class="badge badge-danger">7</span>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="messagesDropdown">
            <a class="dropdown-item" href="#">Action</a>
            <a class="dropdown-item" href="#">Another action</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#">Something else here</a>
          </div>
        </li>
        <li class="nav-item dropdown no-arrow">
          <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-user-circle fa-fw"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
            <a class="dropdown-item" href="#">Settings</a>
            <a class="dropdown-item" href="/profile">Profile</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">Logout</a>
          </div>
        </li>
      </ul>

    </nav>

    <div id="wrapper">

      <!-- Sidebar -->
      <ul class="sidebar navbar-nav">
        <li class="nav-item active">
          <a class="nav-link" href="client_main">
            <i class="fas fa-fw fa-table"></i>
            <span>Main</span>
          </a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="pagesDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="fas fa-fw fa-tachometer-alt"></i>
              <span>Apps</span>
            </a>
            <div class="dropdown-menu" aria-labelledby="pagesDropdown" x-placement="bottom-start" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(5px, 56px, 0px);">
              <!-- <h6 class="dropdown-header">App</h6> -->
              <a class="dropdown-item" href="client_main">List</a>
              <a class="dropdown-item" href="app_Status">Status</a>
              <a class="dropdown-item" href="history">History</a>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="pagesDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="fas fa-fw fa-chart-area"></i>
              <span>Data</span>
            </a>
            <div class="dropdown-menu" aria-labelledby="pagesDropdown" x-placement="bottom-start" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(5px, 56px, 0px);">
              <!-- <h6 class="dropdown-header">Developer Page</h6> -->
              <a class="dropdown-item" href="developer_main">List</a>
            </div>
          </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="pagesDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-fw fa-chart-area"></i>
            <span>Spark</span>
          </a>
          <div class="dropdown-menu" aria-labelledby="pagesDropdown" x-placement="bottom-start" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(5px, 56px, 0px);">
            <h6 class="dropdown-header">Status</h6>
            <a class="dropdown-item" href="Cluster">Cluster</a>
            <a class="dropdown-item" href="Hdfs">Hdfs</a>
            <a class="dropdown-item" href="Yarn">Yarn</a>
            <a class="dropdown-item" href="zoo">Zookeeper</a>
          </div>
        </li>
       
      </ul>
      <div id="content-wrapper">
        <div class="container-fluid">
          <!-- Breadcrumbs-->
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="#">Data</a>
            </li>
            <li class="breadcrumb-item active">List</li>
          </ol>
          <!-- Icon Cards-->
          <div class="card mb-3">
            <div class="card-header">
              <!--working space-->
              <!--Application-->
              <div>
                <select id="appList" name="appList"></select>
                <button id="delApp" name="delApp">delete App</button>
                <!--Application info-->
                <h3 id="appName">[appName]</h3>
                <h3 id="description">[description]</h3>
                <h3 id="author_name">[author.name]</h3>
                <h3 id="email">[author.email]</h3>
                <h3 id="parameters">[parameters]</h3>
                <h3 id="version">[version]</h3>
                <h3 id="type">[type]</h3>
              </div>
              <!--add file&app-->
              <form action="/admin/saveApp"  method="post" enctype="multipart/form-data" id="fileForm" accept-charset="utf-8">
              <input type='file' id='appFile' name='appFile' accept=".py">
              <br>    
              <input type='file' id='metaFile' name='appFile' accept=".json" accept-charset="utf-8">
              </form>
      
              <!--upload btn-->
              <br>
              <button id="uploadBtn">upload button</button>
      
              <!--application help-->
              <br>
              <h4>help</h4>
              <textarea id="metaText" rows="10" cols="50"></textarea>
              <!--confirm btn-->
              <br>
              <button id="confirmBtn">confirm</button>
  
              <!--state-->
              <p>
              <select class="stateList" id="allState" name="allState" size="2">
              </select>
              <select class="stateList" id="runState" name="runState" size="10">
              </select>
              <select class="stateList" id="doneState" name="doneState" size="10">
              </select>
              </p>
              <div class="appState">
                <h4 id="id">id : </h4>
                <h4 id="name">name : </h4>
                <h4 id="elapsedTime">elapsedTime : </h4>
                <h4 id="startedTime">startedTime : </h4>
                <h4 id="finishedTime">finishedTime : </h4>
                <h4 id="state">state : </h4>
              </div>

              <div class="card-footer small text-muted"></div>
              </div>

            </div>
        <!-- /.container-fluid -->

        <!-- Sticky Footer -->
        

      </div>
      <!-- /.content-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top" style="display: none;">
      <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
            <button class="close" type="button" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">×</span>
            </button>
          </div>
          <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
            <a class="btn btn-primary" id="logoutBtn">Logout</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Page level plugin JavaScript-->
    <script src="vendor/chart.js/Chart.min.js"></script>
    <script src="vendor/datatables/jquery.dataTables.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin.min.js"></script>

    <!-- Demo scripts for this page-->
    <script src="js/demo/datatables-demo.js"></script>
    <script src="js/demo/chart-area-demo.js"></script>

    <script>
         
    $('#logoutBtn').click(function(){
        $.ajax({
				url: '/logout',
				type: 'GET',
				success:function(result) {
          alert("success")
          location.href = "/login"
				},	
				error:function(error) {
					console.log("error : " + error)	
				}
			  })
      })

        $('.stateList').change(function() {
			var application_id = $(this).val()
			$.ajax({
				url: '/client/appState',
				dataType: 'json',
				type: 'GET',
				data: {"id":application_id},
				success:function(result) {
					var elapsedTime = result.result.elapsedTime;
					var sec_gap = elapsedTime /1000;
					var min_gap = Math.floor(elapsedTime /1000/60);
					var hour_gap = Math.floor(elapsedTime / 1000 / 60 /60);
					var name = result.result.name;			

					$('#id').html("id : "+result.result.id)
					$('#name').html("name : "+result.result.name)
					$('#elapsedTime').html("elapsedTime : "+  hour_gap + "시" + min_gap+ "분" +sec_gap + "초")
					$('#startedTime').html("startedTime : "+new Date(result.result.startedTime).toString())
					$('#finishedTime').html("finishedTime : "+ new Date(result.result.finishedTime).toString())
					$('#state').html("state : " + result.result.state)
				},	
				error:function(error) {
					console.log("error : " + error)	
				}
			})
		})
		$(document).ready(function() {
			allRefreshState();
			setInterval( allRefreshState ,2000);
		});

    var allStateLen = null
    function allRefreshState() {	
	    $.ajax({
				url: '/client/yarnAllState',
				dataType: 'json',
				type: 'GET',
				success:function(result) {
					var stateLen = result.result.length;
					$('#runState').empty()
					$('#doneState').empty()
					for(var i=0; i<stateLen; i++) {
						var id = result.result[i].id;
						var name = result.result[i].name;
						var state = result.result[i].state;
						if(state == "RUNNING") {
							$('<option id="'+id+'" class="'+state+'" value="'+ id +'" style="background-color:yellow">' + id + '</option>').appendTo('#runState');
						} else if(state=="FINISHED") {
							$('<option id="'+id+'" class="'+state+'" value="'+ id +'" style="background-color:gray">' + id + '</option>').appendTo('#doneState');
						}
					}

					$('#allState').attr("size", stateLen)
					if(allStateLen != stateLen) {
						$('#allState').empty();
						for(var i=0; i<stateLen; i++)
	  					{
							var id = result.result[i].id;
							var name = result.result[i].name;
							var state = result.result[i].state;
							var startedTime = new Date(result.result[i].startedTime).toString();
							if(result.result[i].state == "RUNNING")	{	
								$('<option id="'+id+'" class="'+state+'" value="'+ id +'" style="background-color:yellow">' + id + '</option>').appendTo('#allState');
							} else {		
								$('<option id="'+id+'" class="'+state+'" value="'+ id +'" style="background-color:gray">' + id +  '</option>').appendTo('#allState');
							}
						}
						allStateLen = stateLen;
					}
					else {
						for(var i=0; i<stateLen; i++) {
							var id = result.result[i].id;
							var name = result.result[i].name;
							var currentState = result.result[i].state;
							var beforeClass = $('#'+id).attr('class')
							var startedTime = new Date(result.result[i].startedTime).toString();
							
							if(beforeClass != currentState ) {
								$('#'+id).removeClass(beforeClass);
								$('#'+id).addClass(currentState);
								$('#'+id).html(id)
								var state = ""
								console.log(currentState)
								if(currentState == "ACCEPTED") {
									state = "ACCEPTED"
									$('#'+id).attr('style','background-color:blue');
								} else if(currentState == "RUNNING") {
									state = "RUNNING"
									$('#'+id).attr('style','background-color:yellow');
								} else if(currentState == "FINISHED") {
									state = "FINISHED"
									$('#'+id).attr('style','background-color:gray');
								}
								if($('#allState option:selected').attr('id') == id) {
									$('#state').html("state : "+state)
								}
							}
						}
					}	
				},
				error:function(error) {
					console.log("error : "+ error)
				}
			})
}
        var info ={
            "appName": "",
            "description": "",
            "author": {
                "name" : "",
                "email" : ""
            },
            "parameters": [],
            "version" :  "",
            "type" : ""
        }
        function appListRef() {
            $.ajax({
                url: '/admin/appList',
                method: "GET",
                    success: function(result) {
                    $('#appList').empty();
                    var list = result.result.split("\n");
                    $('#appList').attr("size", list.length-1)
                    //console.log(list)
                    for (var i=0; i<list.length-1; i++){
                        $('#appList').append('<option id='+list[i]+ 'value='+list[i]+'>'+list[i]+'</option>');
                    }
                },
                error : function(error) {
                    console.log(error)
                }
            })
        }
        $('#appList').change(function(){
            var selectedId = $(this).val();
            $.ajax({
                url: "/admin/appData",
                method: "GET",
                data : {"id": selectedId},
                dataType: 'json',
                success: function(result) {
                    var data = result.result;
                    var parameters = ""
                    
                    $('#appName').html("[appName]<br>"+data.appName)
                    $('#description').html("[description]<br>" +data.description)
                    $('#author_name').html("[author.name]<br>"+ data.author.name)
                    $('#email').html("[author.email]<br>"+ data.author.email)
                    $('#version').html("[version]<br>"+data.version)
                    $('#type').html("[type]<br>"+data.type)
                    if (data.parameters.length > 0) {
                        for (let parameter of data.parameters) {
                            console.log()
                            parameters += JSON.stringify(parameter) + "<br>"
                        }
                    }
                    $('#parameters').html("parameters<br>"+ parameters)

                    
                },
                error : function(error) {
                    console.log(error)
                } 
            })
            
        })
        $('#delApp').click(function(){
            var check = confirm("really?")
            if(check) {
                var clickedId = $('#appList').val()
                $.ajax({
                    url: "/admin/delApp",
                    dataType: "json",
                    method: "GET",
                    data : {"id" : clickedId},
                    success: function(result) {
                        if(!result.result) {
                            alert("failed metadata delete ")
                        } else {
                            appListRef()
                        }
                    }, 
                    error : function(error) {
                        console.log(error)
                    }
                })
            }
        })
        $('#appFile').change(function(){
            if(fname == null || fname ==undefined){}
            else {
                var fname = $(this).val().split('.')[1].toLowerCase()
                if(fname != "py"){
                    alert("!!!!!!!")
                    $(this).val(null)
                }
            }
        })
        $('#metaFile').change(function(){
            if(fname ==null || fname == undefined){}
                else {
                var fname = $(this).val().split('.')[1].toLowerCase()
                if(fname != "json"){
                    alert("!!!!!!!")
                    $(this).val(null)
                }
            }
        })
        $(document).ready(function() {
            appListRef();
        })
        $('#uploadBtn').click(function() {
            $('#metaFile').trigger('change')
        })
        function readTextFile(file, callback) {
            var rawFile = new XMLHttpRequest();
                    rawFile.overrideMimeType("application/json;charset=euc-kr");
                    rawFile.open("GET", file, true);
                    rawFile.onreadystatechange = function() {
                    if (rawFile.readyState === 4 && rawFile.status == "200") {
                        callback(rawFile.responseText);
                }
            }
            rawFile.send(null);
        }                   
        $('#metaFile').change(function(e) {
            const files = e.target.files;
            if(files && files.length > 0) {
                const targetFile = files[0]
                try {
                    const path = window.URL.createObjectURL(targetFile)
                    readTextFile(path, function(text){
                        $('#metaText').html(text)
                    });                    
                    $.getJSON(path, function(data) {
                        info.appName = data.appName
                        info.description = data.description
                        info.author.name = data.author.name
                        info.author.email = data.author.email
                        info.version = data.version
                        info.type = data.type
                        
                        var inputParameters = []

                        try {
                        if (data.parameters.length > 0) {
                            for (var i in data.parameters) {
                                inputParameters.push(data.parameters[i])
                            }
                        }
                    } catch (e) {
                        console.log(e)
                        }
                        info.parameters = inputParameters
                    })
                }
                catch(ex) {
                    console.log(ex)
                    try {
                        const fileReader = new FileReader();
                        fileReader.onload = (event) =>  {
                            console.log("fileReader " + event.target.result)
                        }
                        fileReader.readAsDataURL(targetFile)
                    }
                    catch (e) {
                        console.log("file upload not supported : ")
                    }
                }
            }
        })
        
        $('#uploadBtn').click(function() {
            $.getJSON()
            var data = "";
            $('#metaText').html(data)
        })

        $('#confirmBtn').click(function() {

            info = JSON.parse($('#metaText').html())
            //console.log(info)
            
            var appValue = $('#appFile').val().split("\\");
            info.appName = appValue[appValue.length-1];
            var jsonValue = $('#metaFile').val().split("\\")
            if (appValue[appValue.length-1].split(".")[0] == jsonValue[jsonValue.length-1].split(".")[0]) {
               
                //app data
                var form = $('#fileForm')[0];
                var formData = new FormData(form);
                
                formData.append("metaFile",$('#metaFile'))
                //console.log(formData)
                //save : app(.py..) + parameterFile(.json..) in mongodb 
                $.ajax({
                    url: '/admin/saveApp',
                    data: formData,
                    method: 'POST',
                    processData: false,
                    contentType: false,
                    success: function (result) {
                        //console.log(result);
                        if(result.status) {
                            alert("App 업로드에 성공하였습니다.")
                        } else {
                            alert(result.result)
                        }
                        appListRef()
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });       
            } else {
                alert("please same file name")
            }
            
    })
    </script>
  







</body></html>
