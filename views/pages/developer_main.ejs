<html lang="en">
    <% include ../partial/head %>
  <body id="page-top">
      <% include ../partial/toolbar %>
    <div id="wrapper">
        <% include ../partial/sidebar %>
      <div id="content-wrapper">
        <div class="container-fluid">
          <!-- Breadcrumbs-->
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="#">Data</a>
            </li>
            <li class="breadcrumb-item active">List</li>
          </ol>
          <!-- Icon Cards-->
          <div class="card mb-3">
            <div class="card-body">
              <!--working space-->
              <h2><ion-icon name="document"></ion-icon> Data List</h2>
              <p class="lead">You can check a list of data, <kbd>Upload</kbd> it, or <kbd>Delete</kbd> it.</p>
              <table class="table table-hover"> <!-- .table thead th -->
                <thead>
                  <tr>
                    <th scope="col"></th>
                    <th scope="col">Data name</th>
                    <th scope="col">File Size</th>
                    <th scope="col">Description</th>
                    <th scope="col">Uploader</th>
                  </tr>
                </thead>
                <tbody id='select_data'>
                </tbody>
              </table>

              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text">File : </span>
                </div>
                <div class="custom-file">
                  <form id='fileForm' method='post' enctype='multipart/form-data' action=''>
                    <input type="file" class="custom-file-input" id="fileInput" name="fileInput" accept=".txt, .log">
                    <label class="custom-file-label" id="dataFileName" for="fileInput">Choose a file</label>
                  </form>
                </div>
              </div>
              <div class="alert alert-secondary" role="alert" id="data_description" style="display: none">
                  <h5 id="decription_title"><ion-icon name="create"></ion-icon>Data description</h5>
                <hr class="my-2">
                <div class="form-group">
                  <textarea class="form-control" id="description" rows="3" placeholder="please input description of upload data"></textarea>
                </div>
              </div>
              <% if (user.role == 1) { %> <!-- user mode -->
                <button type="button" class="sparkRun btn btn-success" id="data_upload" disabled><b><ion-icon name="save"></ion-icon> DATA FILE UPLOAD</b></button>
              <button type="button" class="sparkRun btn btn-success" id="delete" disabled><b><ion-icon name="close-circle"></ion-icon> DATA FILE DELETE</b></button>
                <% } else if (user.role == 2) {%> <!-- developer mode -->
                  <button type="button" class="sparkRun btn btn-info" id="data_upload" disabled><b><ion-icon name="save"></ion-icon> DATA FILE UPLOAD</b></button>
                  <button type="button" class="sparkRun btn btn-info" id="delete" disabled><b><ion-icon name="close-circle"></ion-icon> DATA FILE DELETE</b></button>
                <% } else {%> <!-- manager mode -->
                  <button type="button" class="sparkRun btn btn-danger" id="data_upload" disabled><b><ion-icon name="save"></ion-icon> DATA FILE UPLOAD</b></button>
              <button type="button" class="sparkRun btn btn-danger" id="delete" disabled><b><ion-icon name="close-circle"></ion-icon> DATA FILE DELETE</b></button>         
                <% } %>
      </div>
    </div>
    <% include ../partial/body %>
    <script>
    //Run when page starts
    $(document).ready(function(){
      listRef()
    });
    //list refresh function
    function listRef() {
        $.ajax({
          url: '/client/makeList',
          method: 'post',
          success: function(result) {
            if(result){
              $('#select_data').empty();
	            for(var i=0 ; i<result.datalist.length ; i++){
                $('#select_data').append(
                '<tr id="'+result.datalist[i].dataName+'"><th scope="row"><div class="checkbox"><label style="font-size: 1em"><input type="checkbox" value="'+result.datalist[i].dataName+'" id="data_check"><span class="cr"><i class="cr-icon fa fa-check"></i></span></label></div></th><td>'+result.datalist[i].dataName+'</td><td>'+result.datalist[i].size+'</td><td>'+result.datalist[i].description+'</td><td>'+result.datalist[i].Uploader+'</td></tr></tr>'
                );
              }
	          }
	        }
        })
      }

    function buttondDisabled(){
      if($('input:checkbox[id=data_check]:checked').length > 0){
        document.getElementById('delete').disabled = false
      } else{
        document.getElementById('delete').disabled = true
      }
      
    }

    $('#select_data').click(function(){
      buttondDisabled()
    })


    $('#fileForm').change(function(){
      document.getElementById('data_upload').disabled = false
      document.getElementById("dataFileName").innerHTML = fileInput.files[0].name
      document.all.data_description.style.display=""
    })

    //upload button function
    $('#data_upload').click(function(){
	    var form = $('#fileForm')[0]
      var formData = new FormData(form)
      var fileSize = fileInput.files[0].size

      console.log(fileSize)

      //add file data to form
      formData.append("description",$('#description').val())
      formData.append("fileSize",fileSize)

      const check = confirm("Do you want upload "+fileInput.files[0].name+"?")
      

	    if($('#fileInput').val() == ""){
          alert('please select upload file')
      }else{
        if(check){
          $.ajax({
  	        url:'/client/dataUpload',
	          processData: false,
            contentType: false,
            data : formData,
	          type: 'POST',
	          success: function(result){
              if(result){
                listRef()
                buttondDisabled()
                document.all.data_description.style.display="none"
                document.getElementById("dataFileName").innerHTML = "Choose a file"
                document.getElementById('data_upload').disabled = true
              }
	          }
          })
        }
	    }
    })
    //delete button function
    $('#delete').click( function() {
      const check = confirm("Do you want delete checked data?")
      if(check){
        if ($('input:checkbox[id=data_check]').is(':checked') == false){
          alert('please select data file')
        }else{
          for(let i = 0 ; $('input:checkbox[id=data_check]:checked').length > 0 ; i++){
            $.ajax({
              url: '/client/dataDelete',
              method: 'post',
              data: {
                'data' : $('input:checkbox[id=data_check]:checked')[i].value
      	      },
              dataType: 'json',
              success: function(result) {
                if(!result.result){
                  alert('delete failed')
                }else{
                  listRef()
                  buttondDisabled()
                  document.getElementById('delete').disabled = true
                }
              }
            })
          }
        }
      }
      
		})
    </script>
</body>
</html>
